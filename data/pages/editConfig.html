<!DOCTYPE html>
<html>

<head>
    <title>Config editor</title>

    <style type="text/css">
        body {
            background-color: RGB(37, 37, 37);
        }
        
        select,
        input,
        button {
            color: rgb(153, 153, 153);
            background-color: RGB(49, 51, 53);
        }
        
        td,
        legend,
        label {
            color: rgb(153, 153, 153);
        }
        
        fieldset {
            margin: auto;
            width: 290px;
        }
        
        .splitDiv {
            display: block;
            height: 20px;
        }
        
        .tdName {
            width: 130px;
        }
        
        .formSubmit {
            float: right;
            width: 75px;
        }
    </style>

    <script>
        var splitDiv;

        window.onload = function() {

            splitDiv = document.createElement("div");
            splitDiv.className = "splitDiv";

            SendRequest(null, "/editConfig/getConfig", ParseConfig);
        }

        function ParseConfig() {
            let configs = JSON.parse(this.response);

            configs.forEach(element => {

                let form = new FormData();
                form.append("name", element.fileName);
                SendRequest(form, "/edit/getFileData", function() {

                    let json = JSON.parse(this.response);
                    let name = element.name;
                    let fileName = element.fileName;

                    switch (element.type) {
                        case "color":
                            ParseColorConfig(name, fileName, json);
                            break;
                        default:
                            break;
                    }
                });


            });
        }

        function ParseColorConfig(name, fileName, json) {

            let fieldset = document.createElement("fieldset");
            let legend = document.createElement("legend");
            legend.textContent = name;
            fieldset.append(legend);

            let form = document.createElement("form");
            form.name = name;
            fieldset.append(form);

            let hidden = document.createElement("input");
            hidden.hidden = true;
            hidden.name = "fileName";
            hidden.value = fileName;
            form.append(hidden);

            let table = document.createElement("table");

            for (let key in json) {
                var tr = document.createElement("tr");

                let td = document.createElement("td");
                td.className = "tdName";
                td.textContent = key;
                tr.append(td);

                td = document.createElement("td");
                let input = document.createElement("input");
                input.type = "color";
                input.name = key;
                input.value = rgbToHex(json[key]);
                td.append(input);
                tr.append(td);

                table.append(tr);
            }

            form.append(table);

            let btn = document.createElement("button");
            btn.className = "formSubmit";
            btn.textContent = "Set";
            btn.onclick = () => SendColor(name);
            fieldset.append(btn);

            document.body.append(fieldset);
            document.body.append(splitDiv.cloneNode());
        }

        function SendColor(formName) {
            let formData = new FormData(document.forms[formName]);

            let fileName = formData.get("fileName");
            formData.delete("fileName");

            let config = {};

            formData.forEach(function(value, key) {
                config[key] = HexToRGB(value);
            });

            let sendForm = new FormData();
            sendForm.append("name", fileName);
            sendForm.append("data", JSON.stringify(config));

            SendRequest(sendForm, "/edit/saveFileData", SendResetCommand);
        }

        function HexToRGB(hex) {
            let r = 0;
            let g = 0;
            let b = 0;

            // 3 digits
            if (hex.length == 4) {
                r = "0x" + hex[1] + hex[1];
                g = "0x" + hex[2] + hex[2];
                b = "0x" + hex[3] + hex[3];

                // 6 digits
            } else if (hex.length == 7) {
                r = "0x" + hex[1] + hex[2];
                g = "0x" + hex[3] + hex[4];
                b = "0x" + hex[5] + hex[6];
            }

            let rgb = {
                red: parseInt(r).toString(10),
                green: parseInt(g).toString(10),
                blue: parseInt(b).toString(10),
            }

            return rgb;
        }

        function SendResetCommand() {
            let formData = new FormData();
            formData.append("command", "{reload-command}");
            SendRequest(formData, "/monitor/sendCommand", null);
        }

        function SendRequest(formData, url, onload) {
            let request = new XMLHttpRequest();
            request.open("POST", url, false);
            request.onloadend = onload;
            request.send(formData);
        }

        function rgbToHex(rgbJson) {
            return "#" +
                componentToHex(parseInt(rgbJson.red)) +
                componentToHex(parseInt(rgbJson.green)) +
                componentToHex(parseInt(rgbJson.blue));
        }

        function componentToHex(c) {
            var hex = c.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }
    </script>
</head>

<body>
</body>

</html>